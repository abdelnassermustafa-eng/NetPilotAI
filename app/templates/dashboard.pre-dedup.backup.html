{% extends "base.html" %}
{% block content %}

<h1 class="text-2xl font-semibold text-slate-800 mb-6">
    AWS Network Inventory
</h1>

<!-- ROOT ALPINE CONTROLLER -->
<div x-data="networkConsole()" x-init="init()" class="space-y-6">
    <!-- ================= CREATE ROUTE TABLE MODAL ================= -->
    <div x-show="showCreateRTB" x-cloak class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

        <div class="bg-white p-6 rounded-lg shadow-lg w-[28rem]">
            <h2 class="text-lg font-semibold mb-4">Create New Route Table</h2>

            <template x-if="rtbCreateError">
                <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                    x-text="rtbCreateError"></div>
            </template>

            <label class="block mb-1 font-semibold">VPC</label>
            <select x-model="newRTBVPC" class="border p-2 rounded w-full mb-3">
                <option value="">-- Select VPC --</option>
                <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                    <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                </template>
            </select>

            <label class="block mb-1 font-semibold">Name</label>
            <input type="text" x-model="newRTBName" class="border p-2 rounded w-full mb-3" />

            <label class="block mb-1 font-semibold">Description</label>
            <textarea x-model="newRTBDescription" class="border p-2 rounded w-full mb-4" rows="3"></textarea>

            <div class="flex justify-end space-x-3">
                <button type="button" @click="closeCreateRTBModal()"
                    class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                    Cancel
                </button>

                <button type="button" @click="submitCreateRTB()"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Create
                </button>
            </div>

        </div>
    </div>

    <!-- ============================= -->
    <!-- GLOBAL HEALTH TOOLBAR -->
    <!-- ============================= -->
    <div class="flex justify-end">
        <!-- BACKEND & AWS HEALTH TOOLBAR -->
        <div class="flex items-center gap-3">

            <!-- Health Button -->
            <button @click="checkAllHealth()" class="px-3 py-1 text-sm rounded border border-gray-400 hover:bg-gray-100"
                title="Check backend and AWS health">
                Health
            </button>

            <!-- Backend Health -->
            <div class="flex items-center gap-1 text-xs">
                <span>Backend</span>
                <span :class="{
                                'bg-green-500': backendHealth?.status === 'ok',
                                'bg-red-500': backendHealth?.status === 'failed',
                                'bg-gray-400': !backendHealth
                            }" class="w-3 h-3 rounded-full inline-block"></span>
            </div>

            <!-- AWS Health -->
            <div class="flex items-center gap-1 text-xs">
                <span>AWS</span>
                <span :class="{
                                'bg-green-500': awsHealth?.status === 'ok',
                                'bg-red-500': awsHealth?.status === 'failed',
                                'bg-gray-400': !awsHealth
                            }" class="w-3 h-3 rounded-full inline-block"></span>
            </div>

            <!-- AWS Legacy Health -->
            <div class="flex items-center gap-1 text-xs">
                <span>AWS (Legacy)</span>
                <span :class="{
                                'bg-green-500': awsLegacyHealth?.status === 'ok',
                                'bg-red-500': awsLegacyHealth?.status === 'failed',
                                'bg-yellow-400': awsLegacyHealth?.status === 'unknown',
                                'bg-gray-400': !awsLegacyHealth
                            }" class="w-3 h-3 rounded-full inline-block"></span>
            </div>

        </div>
    </div>



    <!-- GLOBAL ERROR BAR -->
    <template x-if="globalError">
        <div class="mb-4 bg-red-100 text-red-800 border border-red-300 px-4 py-2 rounded text-sm" x-text="globalError">
        </div>
    </template>

    <!-- MAIN TABS -->
    <div class="border-b border-slate-200 mb-4">
        <nav class="flex space-x-4">
            <button @click="activeTab = 'network'" :class="activeTab === 'network'
                ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                üåê VPCs & Subnets
            </button>

            <button @click="activeTab = 'routes'" :class="activeTab === 'routes'
                ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                üì¶ Route Tables
            </button>

            <button @click="activeTab = 'igws'; loadInternetGateways()" :class="activeTab === 'igws'
                ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                üåê Internet Gateways
            </button>

            <button @click="activeTab = 'nat'; loadNatGateways()" :class="activeTab === 'nat'
                ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                ‚öôÔ∏è NAT Gateways
            </button>

            <button @click="activeTab = 'validation'" :class="activeTab === 'validation'
                    ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                    : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                üß™ Validation & Operations
            </button>

            <button @click="activeTab = 'logs'" :class="activeTab === 'logs'
                    ? 'px-3 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600'
                    : 'px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-800'">
                üìä Observability
            </button>



        </nav>
    </div>
    <div x-show=" activeTab==='network'" x-cloak class=" space-y-6">
        <div class="flex justify-end">
            <button @click="showVpcInfo = !showVpcInfo" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                <span x-show="!showVpcInfo">Show information</span>
                <span x-show="showVpcInfo">Hide information</span>
            </button>
        </div>


        <!-- ================= VPC & SUBNETS INFO ================= -->
        <div x-show="showVpcInfo" x-transition class="bg-slate-50 border border-slate-200 rounded-lg p-5">

            <p class="text-slate-700 mb-3">
                Virtual Private Clouds (VPCs) provide isolated networking environments
                in AWS. Subnets divide a VPC into smaller network segments that control
                traffic flow, availability, and routing behavior.
            </p>

            <ul class="list-disc list-inside text-slate-700 space-y-2 text-sm">
                <li>
                    <strong>Create VPC:</strong>
                    Creates a new Virtual Private Cloud with a defined CIDR range
                    (for example <code class="bg-slate-200 px-1 rounded">10.0.0.0/16</code>).
                    <br />
                    <span class="text-slate-500">
                        Each VPC is isolated and must be explicitly connected to other
                        networks using gateways, routing, or peering.
                    </span>
                </li>

                <li>
                    <strong>Create Subnet:</strong>
                    Creates a subnet inside a selected VPC and Availability Zone.
                    Subnets determine whether workloads are public or private based on
                    their routing configuration.
                </li>
            </ul>

            <hr class="my-4 border-slate-300" />

            <h3 class="font-semibold text-slate-800 mb-1">
                VPC Table
            </h3>
            <ul class="list-disc list-inside text-slate-700 space-y-2 text-sm mb-3">
                <li>
                    Displays all VPCs in the current region, including CIDR ranges and
                    default/main status.
                </li>
                <li>
                    <strong>Delete:</strong>
                    Removes a VPC only if it has no dependent resources
                    (subnets, gateways, route tables, or NAT gateways).
                    <br />
                    <span class="text-slate-500">
                        Default VPCs cannot be deleted.
                    </span>
                </li>
            </ul>

            <h3 class="font-semibold text-slate-800 mb-1">
                Subnets Table
            </h3>
            <ul class="list-disc list-inside text-slate-700 space-y-2 text-sm">
                <li>
                    Shows subnets associated with VPCs, including CIDR blocks,
                    Availability Zones, and VPC ownership.
                </li>
                <li>
                    Public or private behavior is determined by the subnet‚Äôs route table,
                    not by the subnet itself.
                </li>
                <li>
                    <strong>Delete:</strong>
                    Deletes a subnet only if no resources (EC2, NAT, ENIs) are attached.
                </li>
            </ul>
        </div>

        <!-- ACTION BAR -->
        <div class="flex space-x-3">
            <button @click="showCreateVPC = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                + Create VPC
            </button>

            <button @click="showCreateSubnet = true"
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                + Create Subnet
            </button>

            <button @click="reloadAll()" class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                Refresh
            </button>
        </div>

        <!-- ================= CREATE VPC MODAL ================= -->
        <div x-show="showCreateVPC" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-lg font-semibold mb-4">Create New VPC</h2>

                <input type="text" placeholder="CIDR (e.g. 10.0.0.0/16)" x-model="newVpcCidr"
                    class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="showCreateVPC = false" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="createVPC(); showCreateVPC = false"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= CREATE SUBNET MODAL ================= -->
        <div x-show="showCreateSubnet" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-[28rem]">
                <h2 class="text-lg font-semibold mb-4">Create New Subnet</h2>

                <template x-if="subnetError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="subnetError"></div>
                </template>

                <label class="block mb-1 font-semibold">VPC</label>
                <select x-model="newSubnetVPC" class="border p-2 rounded w-full mb-2">
                    <option value="">-- Select VPC --</option>
                    <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                        <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                    </template>
                </select>

                <input type="text" placeholder="Or type VPC ID manually" x-model="newSubnetVPCManual"
                    class="border p-2 rounded w-full mb-3" />

                <label class="block mb-1 font-semibold">CIDR</label>
                <input type="text" placeholder="10.0.1.0/24" x-model="newSubnetCIDR"
                    class="border p-2 rounded w-full mb-3" />

                <label class="block mb-1 font-semibold">Availability Zone</label>
                <select x-model="newSubnetAZ" class="border p-2 rounded w-full mb-3">
                    <option value="">-- Select AZ --</option>
                    <template x-for="az in availabilityZones" :key="az">
                        <option :value="az" x-text="az"></option>
                    </template>
                </select>

                <label class="block mb-1 font-semibold">Name (optional)</label>
                <input type="text" x-model="newSubnetName" class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="closeSubnetModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitCreateSubnet()"
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= VPC TABLE ================= -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Existing VPCs</h2>

            <table class="min-w-full border border-slate-300 rounded">
                <thead class="bg-slate-200">
                    <tr>
                        <th class="px-4 py-2 border">VPC ID</th>
                        <th class="px-4 py-2 border">CIDR</th>
                        <th class="px-4 py-2 border">State</th>
                        <th class="px-4 py-2 border">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                        <tr>
                            <td class="px-4 py-2 border" x-text="vpc.vpc_id"></td>
                            <td class="px-4 py-2 border" x-text="vpc.cidr"></td>
                            <td class="px-4 py-2 border" x-text="vpc.state"></td>
                            <td class="px-4 py-2 border space-x-2">
                                <button @click="deleteVPC(vpc)"
                                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                    Delete
                                </button>

                                <button @click="safeDeleteVPC(vpc)"
                                    class="bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600">
                                    Safe Delete
                                </button>
                            </td>

                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- ================= SUBNET TABLE ================= -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Subnets</h2>

            <div class="mb-4 bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p class="text-sm text-slate-700">
                    Go to <strong>Validations &amp; Operations</strong> tab to validate the operations of
                    Subnets, Route
                    tables, Internet Gateways, Nat Gateways and Network Interfaces for your selected VPC
                </p>

                <div class="mt-3 flex items-center gap-3">
                    <label class="text-sm font-semibold text-slate-700">VPC</label>

                    <select x-model="selectedVpcId" @change="onVpcSelected()"
                        class="border rounded px-3 py-2 text-sm w-[34rem] bg-white text-slate-700">

                        <option value="" disabled>Select VPC</option>
                        <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                            <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                        </template>
                    </select>

                    <span class="text-xs text-slate-500" x-show="selectedVpcId">
                        Selected: <span class="font-mono" x-text="selectedVpcId"></span>
                    </span>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <template x-if="eniError">
                        <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                            x-text="eniError"></div>
                    </template>

                    <template x-if="eniLoading">
                        <div class="text-sm italic text-slate-500">Loading interfaces‚Ä¶</div>
                    </template>

                    <template x-if="!eniLoading && (!enis || enis.length === 0)">
                        <div class="text-sm text-slate-600">
                            No interfaces found for the selected VPC.
                        </div>
                    </template>

                    <template x-if="!eniLoading && enis && enis.length">
                        <table class="min-w-full border border-slate-300 rounded">
                            <thead class="bg-slate-200">
                                <tr>
                                    <th class="px-4 py-2 border">ENI ID</th>
                                    <th class="px-4 py-2 border">Subnet ID</th>
                                    <th class="px-4 py-2 border">Status</th>
                                </tr>
                            </thead>

                            <tbody>
                                <template x-for="eni in enis" :key="eni.network_interface_id">
                                    <tr>
                                        <td class="px-4 py-2 border font-mono text-sm"
                                            x-text="eni.network_interface_id"></td>
                                        <td class="px-4 py-2 border font-mono text-sm" x-text="eni.subnet_id || '‚Äî'">
                                        </td>
                                        <td class="px-4 py-2 border text-sm" x-text="eni.status || '‚Äî'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                </div>
            </div>
            <table class="min-w-full border border-slate-300 rounded">
                <thead class="bg-slate-200">
                    <tr>
                        <th class="px-4 py-2 border">Subnet ID</th>
                        <th class="px-4 py-2 border">VPC ID</th>
                        <th class="px-4 py-2 border">CIDR</th>
                        <th class="px-4 py-2 border">AZ</th>
                        <th class="px-4 py-2 border">State</th>
                        <th class="px-4 py-2 border">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="subnet in subnets" :key="subnet.subnet_id">
                        <tr>
                            <td class="px-4 py-2 border" x-text="subnet.subnet_id"></td>
                            <td class="px-4 py-2 border" x-text="subnet.vpc_id"></td>
                            <td class="px-4 py-2 border" x-text="subnet.cidr"></td>
                            <td class="px-4 py-2 border" x-text="subnet.availability_zone"></td>
                            <td class="px-4 py-2 border" x-text="subnet.state"></td>
                            <td class="px-4 py-2 border">
                                <button @click="deleteSubnet(subnet)"
                                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- INTERNET GATEWAYS TAB -->
    <div x-show="activeTab === 'igws'" x-cloak class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-2">Internet Gateways</h2>
            <p class="text-sm text-slate-500">
                Internet Gateway inventory and attachment status.
            </p>
        </div>
    </div>

    <!-- NAT GATEWAYS TAB -->
    <div x-show="activeTab === 'nat'" x-cloak class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-2">NAT Gateways</h2>
            <p class="text-sm text-slate-500">
                NAT Gateway inventory and routing dependencies.
            </p>
        </div>
    </div>


    <!-- ============================================================= -->
    <!-- TAB 2: ROUTE TABLES -->
    <!-- ============================================================= -->
    <div x-show="activeTab === 'routes'" x-cloak class="space-y-8">
        <!-- ================= ROUTE TABLES INFO ================= -->
        <div class="flex justify-end mb-2">
            <button @click="showRoutesInfo = !showRoutesInfo"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                <span x-show="!showRoutesInfo">Show information</span>
                <span x-show="showRoutesInfo">Hide information</span>
            </button>
        </div>

        <div x-show="showRoutesInfo" x-transition class="bg-slate-50 border border-slate-200 rounded-lg p-5">

            <h2 class="text-lg font-semibold text-slate-800 mb-2">
                Route Tables
            </h2>

            <p class="text-slate-700 mb-3">
                Route Tables control how network traffic is directed within a VPC.
                Each route table contains a set of rules (routes) that determine where
                traffic is forwarded based on destination CIDR.
            </p>

            <ul class="list-disc list-inside text-slate-700 space-y-2 text-sm">
                <li>
                    <strong>Create Route Table:</strong>
                    Creates a new, empty route table within a selected VPC.
                    Newly created route tables are not associated with any subnets by default.
                </li>

                <li>
                    <strong>Associate:</strong>
                    Links a route table to a subnet. Once associated, the subnet uses
                    this route table to determine outbound traffic paths.
                    <br />
                    <span class="text-slate-500">
                        (The Associate button disappears when the route table is already
                        associated with the selected subnet.)
                    </span>
                </li>

                <li>
                    <strong>De-associate:</strong>
                    Removes a subnet association from a route table.
                    The subnet will then fall back to the VPC‚Äôs main route table.
                    <br />
                    <span class="text-slate-500">
                        (This option is hidden for the main route table.)
                    </span>
                </li>

                <li>
                    <strong>Add Route:</strong>
                    Adds a new routing rule, such as:
                    <ul class="list-disc list-inside ml-5 mt-1 space-y-1">
                        <li>
                            <code class="bg-slate-200 px-1 rounded">0.0.0.0/0 ‚Üí IGW</code>
                            for public internet access
                        </li>
                        <li>
                            <code class="bg-slate-200 px-1 rounded">0.0.0.0/0 ‚Üí NAT Gateway</code>
                            for private subnet outbound access
                        </li>
                    </ul>
                </li>

                <li>
                    <strong>Delete Route Table:</strong>
                    Permanently removes a route table.
                    <br />
                    <span class="text-slate-500">
                        (Deletion is disabled for the VPC‚Äôs main route table and for
                        route tables that still have subnet associations.)
                    </span>
                </li>
            </ul>
        </div>

        <!-- ============================================================= -->
        <div class="flex space-x-3">
            <button @click="openCreateRTBModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                + Create Route Table
            </button>

            <button @click="loadRouteTables()" class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                Refresh Route Tables
            </button>

        </div>

        <!-- ================= ASSOCIATE ROUTE TABLE MODAL ================= -->
        <div x-show="showAssociateRTB" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-lg font-semibold mb-4">Associate Route Table</h2>

                <template x-if="rtbAssocError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="rtbAssocError"></div>
                </template>

                <p class="text-sm mb-2">
                    <strong>Route Table:</strong>
                    <span x-text="selectedRTBId"></span>
                </p>

                <label class="block mb-1 font-semibold">Subnet</label>
                <select x-model="selectedSubnetForAssoc" class="border p-2 rounded w-full mb-4">
                    <option value="">-- Select Subnet --</option>
                    <template x-for="sn in candidateSubnetsForRTB" :key="sn.subnet_id">
                        <option :value="sn.subnet_id" x-text="`${sn.subnet_id} (${sn.cidr})`"></option>
                    </template>
                </select>

                <div class="flex justify-end space-x-3">
                    <button @click="closeAssocModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="associateRouteTable()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Associate
                    </button>

                </div>
            </div>
        </div>

        <!-- ================= ADD ROUTE MODAL ================= -->
        <div x-show="showAddRoute" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-[28rem]">
                <h2 class="text-lg font-semibold mb-4">Add Route</h2>

                <template x-if="addRouteError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="addRouteError"></div>
                </template>

                <label class="block mb-1 font-semibold">Destination CIDR</label>
                <input type="text" x-model="addRouteDestination" placeholder="0.0.0.0/0"
                    class="border p-2 rounded w-full mb-3" />

                <label class="block mb-1 font-semibold">Target Type</label>
                <select x-model="addRouteTargetType" class="border p-2 rounded w-full mb-3">
                    <option value="igw">Internet Gateway</option>
                    <option value="nat">NAT Gateway</option>
                </select>

                <label class="block mb-1 font-semibold">Target ID</label>
                <input type="text" x-model="addRouteTargetId" class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="closeAddRouteModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitAddRoute()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Add Route
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= ROUTE TABLES TABLE ================= -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Route Tables</h2>

            <table class="min-w-full border border-slate-300 rounded">
                <thead class="bg-slate-200">
                    <tr>
                        <th class="px-4 py-2 border">RTB ID</th>
                        <th class="px-4 py-2 border">VPC</th>
                        <th class="px-4 py-2 border">Main</th>
                        <th class="px-4 py-2 border">Associations</th>
                        <th class="px-4 py-2 border">Routes</th>
                        <th class="px-4 py-2 border">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    <template x-for="rt in routeTables" :key="rt.route_table_id">
                        <tr class="align-top">
                            <td class="px-4 py-2 border font-mono" x-text="rt.route_table_id"></td>
                            <td class="px-4 py-2 border font-mono" x-text="rt.vpc_id"></td>
                            <td class="px-4 py-2 border" x-text="rt.is_main ? 'Yes' : 'No'"></td>

                            <td class="px-4 py-2 border text-sm space-y-1">
                                <template x-if="!rt.associations_details || rt.associations_details.length === 0">
                                    <span class="text-slate-400">None</span>
                                </template>

                                <template x-for="assoc in rt.associations_details" :key="assoc.association_id">
                                    <div class="flex items-center justify-between gap-2">
                                        <span class="font-mono text-xs">
                                            <template x-if="assoc.subnet_id">
                                                <span x-text="assoc.subnet_id"></span>
                                            </template>
                                            <template x-if="assoc.main">
                                                <span class="italic text-slate-500">MAIN</span>
                                            </template>
                                        </span>
                                    </div>
                                </template>
                            </td>


                            <td class="px-4 py-2 border text-xs">
                                <ul class="list-disc list-inside space-y-1">
                                    <template x-for="r in rt.routes" :key="r.cidr + r.target">
                                        <li>
                                            <span class="font-mono" x-text="r.cidr"></span>
                                            ‚Üí
                                            <span x-text="r.target"></span>
                                        </li>
                                    </template>
                                </ul>
                            </td>

                            <td class="px-4 py-2 border space-y-2 text-xs">

                                <!-- üü¢ Associate Subnet -->
                                <button @click="openAssocModal(rt)"
                                    class="bg-green-600 text-white px-3 py-1 rounded w-full hover:bg-green-700">
                                    Associate Subnet
                                </button>

                                <!-- üü° De-Associate (only if non-main association exists) -->
                                <button x-show="rt.associations_details && rt.associations_details.some(a => !a.main)"
                                    @click="deassociateRouteTable(
                                        rt.associations_details.find(a => !a.main)?.association_id
                                    )" class="bg-yellow-500 text-black px-3 py-1 rounded w-full hover:bg-yellow-600">
                                    De-Associate
                                </button>

                                <!-- üîµ Add Route -->
                                <button @click="openAddRouteModal(rt)"
                                    class="bg-blue-600 text-white px-3 py-1 rounded w-full hover:bg-blue-700">
                                    Add Route
                                </button>

                                <!-- üî¥ Delete RTB (non-main only) -->
                                <button x-show="!rt.is_main" @click="deleteRouteTable(rt)"
                                    class="bg-red-600 text-white px-3 py-1 rounded w-full hover:bg-red-700">
                                    Delete RTB
                                </button>

                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- TAB 3: INTERNET GATEWAYS -->
    <!-- ============================================================= -->
    <div x-show="activeTab === 'igws'" x-cloak class="space-y-8">

        <!-- ================= INTERNET GATEWAYS INFO ================= -->
        <div class="flex justify-end mb-2">
            <button @click="showIGWInfo = !showIGWInfo" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                <span x-show="!showIGWInfo">Show information</span>
                <span x-show="showIGWInfo">Hide information</span>
            </button>
        </div>

        <div x-show="showIGWInfo" x-transition class="bg-slate-50 border border-slate-200 rounded-lg p-5">

            <h2 class="text-lg font-semibold text-slate-800 mb-2">
                Internet Gateways
            </h2>

            <p class="text-slate-700 mb-3">
                Internet Gateways (IGWs) provide a path between a VPC and the public internet.
                A VPC can have at most one IGW attached, and an IGW can be attached to only
                one VPC at a time.
            </p>

            <ul class="list-disc list-inside text-slate-700 space-y-1 text-sm">
                <li>
                    Attach an IGW to enable internet access for public subnets.
                </li>
                <li>
                    Route Tables must include a default route
                    (<code class="bg-slate-200 px-1 rounded">0.0.0.0/0</code>)
                    pointing to the IGW for outbound internet.
                </li>
                <li>
                    Detaching an IGW is required before it can be deleted.
                </li>
            </ul>
        </div>
        <!-- ========================================================== -->
        <div class="flex justify-between items-center">
            <div class="flex space-x-3">
                <button @click="showCreateIGW = true"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + Create IGW
                </button>

                <button @click="loadInternetGateways()"
                    class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                    Refresh IGWs
                </button>
            </div>
        </div>


        <!-- ATTACH IGW MODAL -->
        <div x-show="showAttachIGW" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-[30rem]">
                <h3 class="text-lg font-semibold mb-3">Attach Internet Gateway</h3>

                <template x-if="igwAttachError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="igwAttachError"></div>
                </template>

                <p class="text-sm text-slate-700 mb-3">
                    <strong>IGW:</strong> <span x-text="selectedIGWId"></span>
                </p>

                <label class="block mb-1 font-semibold">VPC</label>
                <select x-model="selectedVpcForIGWAttach" class="border p-2 rounded w-full mb-3">
                    <option value="">-- Select VPC --</option>
                    <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                        <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                    </template>
                </select>

                <input type="text" x-model="selectedVpcForIGWAttachManual" placeholder="Or type VPC ID manually"
                    class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="closeAttachIGWModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitAttachIGW()"
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Attach
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= CREATE IGW MODAL ================= -->
        <div x-show="showCreateIGW" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-[26rem]">
                <h2 class="text-lg font-semibold mb-4">Create Internet Gateway</h2>

                <template x-if="igwCreateError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="igwCreateError"></div>
                </template>

                <label class="block mb-1 font-semibold">Name (optional)</label>
                <input type="text" x-model="newIGWName" class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="closeCreateIGWModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitCreateIGW()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- IGW TABLE -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Existing Internet Gateways</h2>

                <template x-if="internetGateways && internetGateways.length">
                    <div class="text-sm text-slate-600">
                        Total: <span class="font-semibold" x-text="internetGateways.length"></span>
                    </div>
                </template>
            </div>

            <template x-if="igwError">
                <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                    x-text="igwError">
                </div>
            </template>

            <template x-if="!internetGateways || internetGateways.length === 0">
                <div class="text-sm text-slate-600">
                    No Internet Gateways found in this region.
                </div>
            </template>

            <template x-if="internetGateways && internetGateways.length">
                <table class="min-w-full border border-slate-300 rounded">
                    <thead class="bg-slate-200">
                        <tr>
                            <th class="px-4 py-2 border">IGW ID</th>
                            <th class="px-4 py-2 border">Attached VPC(s)</th>
                            <th class="px-4 py-2 border">Attachment State</th>
                            <th class="px-4 py-2 border">Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        <template x-for="igw in internetGateways" :key="igw.internet_gateway_id">
                            <tr>
                                <td class="px-4 py-2 border font-mono text-sm" x-text="igw.internet_gateway_id">
                                </td>

                                <td class="px-4 py-2 border">
                                    <template x-if="igw.attached_vpc_ids && igw.attached_vpc_ids.length">
                                        <div class="space-y-1">
                                            <template x-for="v in igw.attached_vpc_ids" :key="v">
                                                <div class="text-sm font-mono" x-text="v"></div>
                                            </template>
                                        </div>
                                    </template>

                                    <template x-if="!igw.attached_vpc_ids || igw.attached_vpc_ids.length === 0">
                                        <span class="text-sm text-slate-500">Not attached</span>
                                    </template>
                                </td>

                                <td class="px-4 py-2 border">
                                    <template x-if="igw.attachments && igw.attachments.length">
                                        <div class="space-y-1">
                                            <template x-for="a in igw.attachments" :key="`${a.vpc_id}-${a.state}`">
                                                <div class="text-sm">
                                                    <span class="font-mono" x-text="a.vpc_id"></span>
                                                    <span class="text-slate-500">‚Äî</span>
                                                    <span class="font-semibold" x-text="a.state"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <template x-if="!igw.attachments || igw.attachments.length === 0">
                                        <span class="text-sm text-slate-500">‚Äî</span>
                                    </template>
                                </td>

                                <td class="px-4 py-2 border space-x-2">
                                    <button @click="openAttachIGWModal(igw.internet_gateway_id)"
                                        class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                                        Attach
                                    </button>

                                    <button @click="promptDetachIGW(igw)"
                                        class="bg-amber-500 text-white px-3 py-1 rounded hover:bg-amber-600">
                                        Detach
                                    </button>

                                    <button @click="deleteIGW(igw.internet_gateway_id)"
                                        class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>
        </div>

        <!-- DETACH CONFIRM MODAL -->
        <div x-show="showDetachIGWConfirm" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-[28rem]">
                <h3 class="text-lg font-semibold mb-3">Detach Internet Gateway</h3>

                <template x-if="igwDetachError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="igwDetachError"></div>
                </template>

                <p class="text-sm text-slate-700 mb-2">
                    <strong>IGW:</strong> <span class="font-mono" x-text="selectedIGWId"></span>
                </p>

                <label class="block mb-1 font-semibold">VPC (required)</label>
                <select x-model="selectedVpcForIGWDetach" class="border p-2 rounded w-full mb-3">
                    <option value="">-- Select VPC --</option>
                    <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                        <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                    </template>
                </select>

                <input type="text" x-model="selectedVpcForIGWDetachManual" placeholder="Or type VPC ID manually"
                    class="border p-2 rounded w-full mb-4" />

                <div class="flex justify-end space-x-3">
                    <button @click="closeDetachIGWModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitDetachIGW()"
                        class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600">
                        Detach
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="activeTab === 'nat'" x-cloak class="space-y-6">
        <!-- ================= NAT GATEWAYS INFO ================= -->
        <div class="flex justify-end mb-2">
            <button @click="showNatInfo = !showNatInfo" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                <span x-show="!showNatInfo">Show information</span>
                <span x-show="showNatInfo">Hide information</span>
            </button>
        </div>

        <div x-show="showNatInfo" x-transition class="bg-slate-50 border border-slate-200 rounded-lg p-5">

            <h2 class="text-lg font-semibold text-slate-800 mb-2">
                NAT Gateways
            </h2>

            <p class="text-slate-700 mb-3">
                Network Address Translation (NAT) Gateways enable instances in
                <strong>private subnets</strong> to access the public internet
                while preventing inbound internet traffic from reaching them.
            </p>

            <ul class="list-disc list-inside text-slate-700 space-y-1 text-sm">
                <li>
                    NAT Gateways must be deployed in a <strong>public subnet</strong>
                    that has a route to an Internet Gateway.
                </li>
                <li>
                    Private subnets route outbound traffic
                    (<code class="bg-slate-200 px-1 rounded">0.0.0.0/0</code>)
                    to the NAT Gateway instead of directly to an IGW.
                </li>
                <li>
                    NAT Gateways are <strong>managed, highly available</strong>
                    AWS services and do not require patching or maintenance.
                </li>
                <li>
                    Deleting a NAT Gateway requires that no route tables
                    are actively referencing it.
                </li>
            </ul>
        </div>


        <!-- ACTION BAR -->
        <div class="flex space-x-3">
            <button @click="openCreateNATModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                + Create NAT Gateway
            </button>

            <button @click="loadNatGateways()" class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                Refresh NAT Gateways
            </button>

        </div>

        <!-- ================= CREATE NAT MODAL ================= -->
        <div x-show="showCreateNAT" x-cloak
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">

            <div class="bg-white p-6 rounded-lg shadow-lg w-[28rem]">
                <h2 class="text-lg font-semibold mb-4">Create NAT Gateway</h2>

                <template x-if="natCreateError">
                    <div class="mb-3 bg-red-100 text-red-800 border border-red-300 px-3 py-2 rounded text-sm"
                        x-text="natCreateError"></div>
                </template>

                <label class="block mb-1 font-semibold">Name (optional)</label>
                <input type="text" x-model="newNATName" class="border p-2 rounded w-full mb-3" />

                <label class="block mb-1 font-semibold">Subnet</label>
                <select x-model="newNATSubnetId" class="border p-2 rounded w-full mb-3">
                    <option value="">-- Select Subnet --</option>
                    <template x-for="sn in subnets" :key="sn.subnet_id">
                        <option :value="sn.subnet_id" x-text="`${sn.subnet_id} (${sn.cidr})`"></option>
                    </template>
                </select>

                <p class="text-xs text-slate-500 mb-4">
                    Subnet must be public (has route to an Internet Gateway).
                </p>

                <div class="flex justify-end space-x-3">
                    <button @click="closeCreateNATModal()" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">
                        Cancel
                    </button>

                    <button @click="submitCreateNAT()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= NAT GATEWAYS TABLE ================= -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">NAT Gateways</h2>

            <table class="min-w-full border border-slate-300 rounded">
                <thead class="bg-slate-200">
                    <tr>
                        <th class="px-3 py-2 border">NAT ID</th>
                        <th class="px-3 py-2 border">State</th>
                        <th class="px-3 py-2 border">Subnet</th>
                        <th class="px-3 py-2 border">VPC</th>
                        <th class="px-3 py-2 border">Public IP</th>
                        <th class="px-3 py-2 border">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    <template x-for="ngw in natGateways" :key="ngw.nat_gateway_id">
                        <tr>
                            <td class="px-3 py-2 border font-mono" x-text="ngw.nat_gateway_id"></td>

                            <td class="px-3 py-2 border">
                                <span class="px-2 py-1 text-xs rounded" :class="ngw.state === 'available'
                                        ? 'bg-green-100 text-green-800'
                                        : (ngw.state === 'pending'
                                            ? 'bg-yellow-100 text-yellow-800'
                                            : 'bg-slate-100 text-slate-700')" x-text="ngw.state"></span>
                            </td>

                            <td class="px-3 py-2 border font-mono" x-text="ngw.subnet_id || '‚Äî'"></td>

                            <td class="px-3 py-2 border font-mono" x-text="ngw.vpc_id || '‚Äî'"></td>

                            <td class="px-3 py-2 border font-mono" x-text="ngw.public_ip || '‚Äî'"></td>

                            <td class="px-3 py-2 border">
                                <button @click="deleteNatGateway(ngw)"
                                    class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

    </div>

    <!-- ================= VALIDATION TAB ================= -->
    <div x-show="activeTab === 'validation'" x-cloak class="space-y-6">
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-6">
            <h2 class="text-lg font-semibold text-slate-800">
                Validation & Operations
            </h2>

            <p class="text-slate-600 mt-2">
                This section provides read-only validation, dependency inspection,
                and operational guidance for AWS networking resources.
            </p>

            <ul class="list-disc list-inside mt-4 text-sm text-slate-700 space-y-2">
                <li>Backend health verification</li>
                <li>AWS control-plane health</li>
                <li>Dependency and safety constraints</li>
                <li>CLI equivalents for UI actions</li>
            </ul>

            <div class="mt-4 text-sm text-slate-500 italic">
                Validation data will appear here as features are enabled.
            </div>
        </div>


        <!-- ================= VPC DEPENDENCY INSPECTION (UI ONLY) ================= -->
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-5 space-y-4">
            <!-- ================= BLOCKING SUMMARY ================= -->
            <div x-show="vpcInspectionResult && !vpcInspectionResult.deletable"
                class="border border-amber-300 bg-amber-50 rounded-lg p-4 mb-4">

                <h3 class="font-semibold text-amber-800 mb-2">
                    üö´ Deletion Blocked Due To
                </h3>

                <ul class="space-y-1 text-sm">

                    <!-- Internet Gateways -->
                    <li x-show="internetGatewayInspection.length > 0">
                        üåê <span class="text-indigo-700 font-medium">Internet Gateway</span>:
                        <template x-for="igw in internetGatewayInspection" :key="igw.internet_gateway_id">
                            <span class="ml-1 font-mono font-bold text-slate-900"
                                x-text="igw.internet_gateway_id"></span>
                        </template>
                    </li>


                    <!-- WHY BLOCKING -->
                    <div class="mt-2 ml-4 text-sm text-slate-700 space-y-1">

                        <div>
                            ‚ùå <span class="text-amber-700 font-medium">Cannot delete</span> because this
                            <span class="text-indigo-700 font-medium">Internet Gateway</span> is
                            <span class="font-semibold text-slate-900">attached</span> to the VPC
                            <span class="font-mono font-bold text-slate-900"
                                x-text="vpcInspectionResult?.vpc_id"></span>
                        </div>

                        <div x-show="igw.referenced_by_route_tables && igw.referenced_by_route_tables.length">
                            üîÅ <span class="text-blue-700 font-medium">Referenced by route table</span>

                            <template x-for="rt in igw.referenced_by_route_tables" :key="rt.route_table_id">
                                <div class="ml-4">
                                    ‚Ä¢ <span class="font-mono font-bold text-slate-900"
                                        x-text="rt.route_table_id"></span>
                                    ‚Äî
                                    <span class="text-slate-600">
                                        destination
                                        <span class="font-semibold text-slate-800" x-text="rt.destination"></span>
                                    </span>
                                </div>
                            </template>
                        </div>

                    </div>



                    <!-- NAT Gateways -->
                    <li x-show="vpcInspectionResult.details.nat_gateways?.length">
                        ‚öôÔ∏è <span class="text-emerald-700 font-medium">NAT Gateways</span>:
                        <span class="font-bold text-slate-900"
                            x-text="vpcInspectionResult.details.nat_gateways.length"></span>
                    </li>

                    <!-- Route Tables -->
                    <li x-show="vpcInspectionResult.details.route_tables?.length">
                        üß≠ <span class="text-blue-700 font-medium">Route Tables</span>:
                        <span class="font-bold text-slate-900"
                            x-text="vpcInspectionResult.details.route_tables.length"></span>
                    </li>

                    <!-- Network Interfaces -->
                    <li x-show="vpcInspectionResult.details.network_interfaces?.length">
                        üîå <span class="text-purple-700 font-medium">Network Interfaces</span>:
                        <span class="font-bold text-slate-900"
                            x-text="vpcInspectionResult.details.network_interfaces.length"></span>
                    </li>

                    <!-- Subnets -->
                    <li x-show="vpcInspectionResult.details.subnets?.length">
                        üß© <span class="text-rose-700 font-medium">Subnets</span>:
                        <span class="font-bold text-slate-900"
                            x-text="vpcInspectionResult.details.subnets.length"></span>
                    </li>

                </ul>
            </div>

            <h3 class="text-md font-semibold text-slate-800">
                VPC Dependency Inspection
            </h3>

            <p class="text-sm text-slate-600">
                Inspect why a VPC cannot be safely deleted. This check is read-only and
                does not modify any resources.
            </p>

            <!-- VPC Dependency Inspection -->
            <div class="bg-white rounded-xl shadow p-6 space-y-4">

                <h2 class="text-lg font-semibold text-slate-800">
                    VPC & Subnets
                </h2>

                <p class="text-sm text-slate-600">
                    Live validation of VPC structure and subnet dependencies.
                    Read-only. No resources are modified.
                </p>

                <div class="flex items-center gap-3">

                    <!-- Inspect Button (WORKING) -->
                    <button @click="inspectVpcDependencies" :disabled="inspectingVpc"
                        class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 disabled:opacity-50">
                        <span x-show="!inspectingVpc">Inspect</span>
                        <span x-show="inspectingVpc">Inspecting‚Ä¶</span>
                    </button>

                    <!-- VPC Selector -->
                    <!-- <select x-model="selectedVpcId" @change="onVpcSelected()"
                        class="border rounded px-3 py-2 text-sm w-80 bg-white text-slate-700"> -->

                    <select x-model="selectedVpcId"
                        class="border rounded px-3 py-2 text-sm w-80 bg-white text-slate-700">

                        <option value="" disabled>Select VPC</option>

                        <template x-for="vpc in vpcs" :key="vpc.vpc_id">
                            <option :value="vpc.vpc_id" x-text="`${vpc.vpc_id} (${vpc.cidr})`"></option>
                        </template>
                    </select>

                </div>

                <!-- ================= VALIDATION DETAILS ================= -->
                <div x-show="vpcInspectionResult && vpcInspectionResult.details" class="mt-6 border-t pt-4 space-y-1">

                    <h3 class="text-md font-semibold text-slate-800">
                        Validation Details
                    </h3>

                    <!-- ================= SUBNETS (INVENTORY) ================= -->
                    <div>
                        <button @click="expandedValidation.subnets = !expandedValidation.subnets"
                            class="text-sm font-medium text-slate-700 hover:underline">

                            ‚ñ∏ Subnets (inventory)
                            (<span x-text="vpcInspectionResult.summary.subnets"></span>)
                        </button>

                        <ul x-show="expandedValidation.subnets" class="mt-2 ml-4 text-sm text-slate-600 space-y-1">

                            <template x-for="s in vpcInspectionResult.details.subnets" :key="s.subnet_id">

                                <li>
                                    ‚Ä¢ <strong x-text="s.subnet_id"></strong>
                                    (<span x-text="s.cidr"></span>,
                                    <span x-text="s.availability_zone"></span>)
                                </li>

                            </template>
                        </ul>
                    </div>

                    <!-- ================= SUBNETS (INSPECTION) ================= -->
                    <div>

                        <button @click="expandedValidation.subnets_inspection = !expandedValidation.subnets_inspection"
                            class="text-sm font-medium text-slate-700 hover:underline">

                            ‚ñ∏ Subnets (inspection)
                            (<span x-text="subnetInspection?.summary?.total_subnets || 0"></span>)
                        </button>

                        <div x-show="expandedValidation.subnets_inspection" class="mt-2 ml-4 space-y-4">

                            <!-- Loading -->
                            <div x-show="subnetLoading" class="text-sm italic text-slate-500">
                                Loading subnets‚Ä¶
                            </div>

                            <!-- Error -->
                            <div x-show="subnetError" class="text-sm text-red-600">
                                <span x-text="subnetError"></span>
                            </div>

                            <!-- SUMMARY -->
                            <div x-show="subnetInspection && subnetInspection.summary && !subnetLoading"
                                class="text-sm text-slate-600 space-y-1">

                                <div>
                                    ‚Ä¢ Subnets with ENIs:
                                    <strong x-text="subnetInspection.summary.subnets_with_enis"></strong>
                                </div>

                                <div>
                                    ‚Ä¢ Subnets with NAT Gateways:
                                    <strong x-text="subnetInspection.summary.subnets_with_nat"></strong>
                                </div>

                                <div>
                                    ‚Ä¢ With route table association:
                                    <strong
                                        x-text="subnetInspection.summary.subnets_with_route_table_associations"></strong>
                                </div>
                            </div>

                            <!-- DETAILS LIST -->
                            <ul x-show="subnetInspection && subnetInspection.details && !subnetLoading"
                                class="space-y-3 text-sm text-slate-700">

                                <template x-for="sn in subnetInspection.details" :key="sn.subnet_id">

                                    <li class="space-y-2">

                                        <!-- SUBNET SUMMARY -->
                                        <div>
                                            ‚Ä¢ <strong class="font-mono font-bold" x-text="sn.subnet_id"></strong>
                                            ‚Äî
                                            <span x-text="sn.cidr"></span>,
                                            AZ:
                                            <span x-text="sn.availability_zone"></span>,
                                            state:
                                            <span x-text="sn.state"></span>
                                        </div>

                                        <!-- BLOCKING REASONS -->
                                        <div class="ml-6 text-sm space-y-1">

                                            <div x-show="sn.eni_count > 0">
                                                üîó <span class="font-medium">Attached ENIs:</span>
                                                <span class="font-bold" x-text="sn.eni_count"></span>
                                            </div>

                                            <div x-show="sn.nat_gateway_count > 0">
                                                üåê <span class="font-medium">NAT Gateways in subnet:</span>
                                                <span class="font-bold" x-text="sn.nat_gateway_count"></span>
                                            </div>

                                            <div x-show="sn.route_table_associated">
                                                üß≠ <span class="font-medium">
                                                    Associated with a route table
                                                </span>
                                            </div>

                                            <div x-show="sn.can_delete" class="text-emerald-700 font-medium">
                                                ‚úÖ Safe to delete
                                            </div>

                                        </div>

                                        <!-- SAFE DELETION PLAYBOOK -->
                                        <div class="ml-6 border border-slate-200 rounded-lg
                                                    p-4 bg-slate-50 text-xs text-slate-800">

                                            <div class="font-semibold mb-2">
                                                üõ°Ô∏è Subnet Safe Deletion Playbook
                                            </div>

                                            <!-- BLOCKED -->
                                            <div x-show="!sn.can_delete" class="space-y-2">

                                                <div x-show="sn.eni_count > 0">
                                                    ‚ùå Detach or delete
                                                    <strong x-text="sn.eni_count"></strong>
                                                    network interface<span x-show="sn.eni_count > 1">s</span>
                                                    before deletion.
                                                </div>

                                                <div x-show="sn.nat_gateway_count > 0">
                                                    ‚ùå Delete NAT Gateway<span x-show="sn.nat_gateway_count > 1">s</span>
                                                    in this subnet first.
                                                </div>

                                                <div x-show="sn.route_table_associated">
                                                    ‚ö†Ô∏è Route table association must be removed
                                                    (if not main).
                                                </div>
                                            </div>

                                            <!-- SAFE -->
                                            <div x-show="sn.can_delete">

                                                <div class="mb-2">
                                                    <span class="font-semibold text-indigo-700">1.</span>
                                                    Verify no ENIs or NAT Gateways remain
                                                </div>

                                                <div class="mb-2">
                                                    <span class="font-semibold text-indigo-700">2.</span>
                                                    Delete subnet
                                                </div>

                                                <pre class="mt-1 bg-white p-2 rounded border font-mono">
                aws ec2 delete-subnet \
                --subnet-id <span x-text="sn.subnet_id"></span>
                                                </pre>
                                            </div>

                                            <div class="mt-2 italic text-slate-500">
                                                Read-only guidance. Commands are not executed automatically.
                                            </div>
                                        </div>

                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>


                <!-- ROUTE TABLES (INSPECTION) -->
                <div x-show="vpcInspectionResult">


                    <button
                        @click="expandedValidation.route_tables_inspection = !expandedValidation.route_tables_inspection"
                        class="text-sm font-medium text-slate-700 hover:underline">

                        ‚ñ∏ Route Tables (inspection)
                        (<span x-text="routeTableInspection?.summary?.total_route_tables || 0"></span>)
                    </button>

                    <div x-show="expandedValidation.route_tables_inspection" class="mt-2 ml-4 space-y-3">

                        <!-- Loading -->
                        <div x-show="routeTableLoading" class="text-sm italic text-slate-500">
                            Loading route tables‚Ä¶
                        </div>

                        <!-- Error -->
                        <div x-show="routeTableError" class="text-sm text-red-600">
                            <span x-text="routeTableError"></span>
                        </div>

                        <!-- SUMMARY -->
                        <div x-show="routeTableInspection && !routeTableLoading"
                            class="text-sm text-slate-600 space-y-1">

                            <div>‚Ä¢ Total route tables:
                                <strong x-text="routeTableInspection.summary.total_route_tables"></strong>
                            </div>
                            <div>‚Ä¢ Main route tables:
                                <strong x-text="routeTableInspection.summary.main_route_tables"></strong>
                            </div>
                            <div>‚Ä¢ Orphaned route tables:
                                <strong x-text="routeTableInspection.summary.orphaned_route_tables"></strong>
                            </div>
                            <div>‚Ä¢ With default route:
                                <strong x-text="routeTableInspection.summary.route_tables_with_default_route"></strong>
                            </div>
                        </div>

                        <!-- DETAILS LIST -->
                        <ul x-show="routeTableInspection && !routeTableLoading"
                            class="mt-2 space-y-2 text-sm text-slate-700">

                            <template x-for="rt in routeTableInspection.details" :key="rt.route_table_id">

                                <!-- ONE LI PER ROUTE TABLE -->
                                <li class="space-y-2">

                                    <!-- ROUTE TABLE SUMMARY LINE -->
                                    <div>
                                        ‚Ä¢ <strong class="font-mono font-bold" x-text="rt.route_table_id"></strong>
                                        <span x-show="rt.is_main" class="text-xs text-blue-600">(Main)</span>
                                        ‚Äî
                                        associations:
                                        <span x-text="rt.association_count"></span>,
                                        default route:
                                        <span x-text="rt.has_default_route ? 'yes' : 'no'"></span>,
                                        state:
                                        <span x-text="rt.state"></span>
                                    </div>

                                    <!-- WHY THIS ROUTE TABLE BLOCKS DELETION -->
                                    <div class="ml-6 text-sm text-slate-700 space-y-1">

                                        <div x-show="rt.is_main">
                                            ‚ùå <span class="text-amber-700 font-medium">Cannot delete</span>
                                            because this is the
                                            <span class="text-indigo-700 font-medium">main route table</span>
                                            for VPC
                                            <span class="font-mono font-bold text-slate-900"
                                                x-text="vpcInspectionResult?.vpc_id"></span>.
                                        </div>

                                        <div x-show="rt.has_default_route">
                                            üîÅ <span class="text-blue-700 font-medium">Default route present</span>
                                            (<span class="font-mono font-bold">0.0.0.0/0</span>)
                                        </div>

                                        <div x-show="rt.association_count > 0">
                                            üîó <span class="font-medium">Associated with</span>
                                            <span class="font-bold" x-text="rt.association_count"></span>
                                            subnet<span x-show="rt.association_count > 1">s</span>
                                        </div>

                                    </div>

                                    <!-- ================= ROUTE TABLE SAFE DELETION PLAYBOOK ================= -->
                                    <div
                                        class="ml-6 border border-slate-200 rounded-lg p-4 bg-slate-50 text-xs text-slate-800">

                                        <div class="font-semibold text-slate-800 mb-2">
                                            üõ°Ô∏è Route Table Safe Deletion Playbook
                                        </div>

                                        <!-- MAIN ROUTE TABLE -->
                                        <div x-show="rt.is_main" class="text-amber-700 font-medium mb-2">
                                            ‚ùå This is the <strong>main route table</strong>.
                                            Main route tables cannot be deleted.
                                        </div>

                                        <!-- NON-MAIN ROUTE TABLE -->
                                        <div x-show="!rt.is_main">

                                            <div class="mb-2">
                                                <span class="font-semibold text-indigo-700">1.</span>
                                                Verify no subnet associations:
                                                <strong x-text="rt.association_count"></strong>
                                            </div>

                                            <div x-show="rt.has_default_route" class="mb-2">
                                                <span class="font-semibold text-indigo-700">2.</span>
                                                Remove default route
                                                (<span class="font-mono font-bold">0.0.0.0/0</span>)
                                            </div>

                                            <div class="mb-2">
                                                <span class="font-semibold text-indigo-700"
                                                    x-text="rt.has_default_route ? '3.' : '2.'">
                                                </span>
                                                Delete route table
                                            </div>

                                            <!-- Commands -->
                                            <pre x-show="rt.has_default_route"
                                                class="mt-1 bg-white p-2 rounded border font-mono">
                                        aws ec2 delete-route \
                                        --route-table-id <span x-text="rt.route_table_id"></span> \
                                        --destination-cidr-block 0.0.0.0/0
                                            </pre>

                                            <pre class="mt-1 bg-white p-2 rounded border font-mono">
                                        aws ec2 delete-route-table \
                                        --route-table-id <span x-text="rt.route_table_id"></span>
                                            </pre>

                                        </div>


                                    </div>

                                    <div class="mt-2 italic text-slate-500">
                                        Read-only guidance. Commands are not executed automatically.
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>


                    <!-- INTERNET GATEWAYS -->
                    <div>
                        <button @click="expandedValidation.internet_gateways = !expandedValidation.internet_gateways"
                            class="text-sm font-medium text-slate-700 hover:underline">
                            ‚ñ∏ Internet Gateways
                            <span x-text="internetGatewayInspection.length"></span>
                        </button>

                        <div x-show="expandedValidation.internet_gateways" x-cloak
                            class="mt-2 ml-4 space-y-4 text-sm text-slate-600">
                            <template x-for="igw in internetGatewayInspection" :key="igw.internet_gateway_id">

                                <div class="border-l-2 border-slate-300 pl-3 space-y-2">

                                    <!-- IGW SUMMARY -->
                                    <div>
                                        ‚Ä¢ <strong class="font-mono text-slate-900"
                                            x-text="igw.internet_gateway_id"></strong>
                                    </div>

                                    <!-- ATTACHMENT INFO -->
                                    <div class="ml-4 space-y-1">

                                        <div>
                                            attached VPC:
                                            <span x-show="igw.attached_vpc_id"
                                                class="font-mono font-bold text-slate-900"
                                                x-text="igw.attached_vpc_id"></span>

                                            <span x-show="!igw.attached_vpc_id" class="italic text-slate-400">
                                                none
                                            </span>
                                        </div>

                                        <div>
                                            attachment state:
                                            <span x-text="igw.attachment_state || 'detached'"></span>
                                        </div>

                                        <div>
                                            blocking deletion:
                                            <span x-show="igw.attached_vpc_id" class="text-amber-600 font-medium">
                                                yes
                                            </span>
                                            <span x-show="!igw.attached_vpc_id" class="text-green-600 font-medium">
                                                no
                                            </span>
                                        </div>

                                        <div x-show="igw.referenced_by_route_tables?.length"
                                            class="text-xs text-slate-500">
                                            referenced by
                                            <span class="font-bold"
                                                x-text="igw.referenced_by_route_tables.length"></span>
                                            route table(s)
                                        </div>

                                    </div>

                                    <!-- WHY BLOCKING -->
                                    <div x-show="igw.attached_vpc_id"
                                        class="mt-2 ml-4 text-sm text-slate-700 space-y-1">

                                        <div>
                                            ‚ùå <span class="text-amber-700 font-medium">Cannot delete</span> because
                                            this
                                            <span class="text-indigo-700 font-medium">Internet Gateway</span> is
                                            <span class="font-semibold text-slate-900">attached</span> to the VPC
                                            <span class="font-mono font-bold text-slate-900"
                                                x-text="igw.attached_vpc_id"></span>.
                                        </div>

                                    </div>

                                    <!-- ================= IGW SAFE DELETION PLAYBOOK ================= -->
                                    <div x-show="igw.attached_vpc_id"
                                        class="mt-3 ml-6 p-3 rounded-lg border border-amber-300 bg-amber-50 text-sm space-y-2">

                                        <div class="font-semibold text-amber-800">
                                            üõ°Ô∏è ‚Äî Internet Gateway Safe Deletion Playbook
                                        </div>

                                        <ol class="list-decimal ml-5 space-y-1 text-slate-700">

                                            <li>
                                                Detach IGW from VPC
                                                <div class="ml-4 text-xs text-slate-600">
                                                    VPC:
                                                    <span class="font-mono font-bold text-slate-900"
                                                        x-text="igw.attached_vpc_id"></span>
                                                </div>
                                            </li>

                                            <li x-show="igw.referenced_by_route_tables?.length">
                                                Remove default routes referencing this IGW
                                                <template x-for="rt in igw.referenced_by_route_tables"
                                                    :key="rt.route_table_id">
                                                    <div class="ml-4 text-xs">
                                                        ‚Ä¢ <span class="font-mono font-bold text-slate-900"
                                                            x-text="rt.route_table_id"></span>
                                                        ‚Üí
                                                        <span class="font-semibold" x-text="rt.destination"></span>
                                                    </div>
                                                </template>
                                            </li>

                                            <li>
                                                Verify no remaining dependencies (NAT, ENIs)
                                            </li>

                                            <li class="text-green-700 font-semibold">
                                                Delete Internet Gateway
                                            </li>

                                        </ol>

                                        <div class="text-xs text-amber-800 italic">
                                            Read-only guidance ‚Äî no actions executed automatically.
                                        </div>
                                        <!-- ================= CLI SAFE DELETION (READ-ONLY) ================= -->
                                        <div
                                            class="mt-3 ml-4 bg-slate-50 border border-slate-200 rounded-lg p-4 text-xs font-mono text-slate-800">

                                            <div class="font-semibold text-slate-700 mb-2">
                                                CLI ‚Äî Internet Gateway Safe Deletion (Read-Only)
                                            </div>

                                            <!-- Step 1 -->
                                            <div class="mb-2">
                                                <span class="font-semibold text-indigo-700">1.</span>
                                                Detach Internet Gateway from VPC
                                                <pre class="mt-1 bg-white p-2 rounded border">
                                    aws ec2 detach-internet-gateway \
                                    --internet-gateway-id <strong x-text="igw.internet_gateway_id"></strong> \
                                    --vpc-id <strong x-text="igw.attached_vpc_id"></strong>
                                            </pre>
                                            </div>

                                            <!-- Step 2 -->
                                            <div class="mb-2">
                                                <span class="font-semibold text-indigo-700">2.</span>
                                                Remove default routes pointing to this IGW
                                                <template x-for="rt in igw.referenced_by_route_tables"
                                                    :key="rt.route_table_id">
                                                    <pre class="mt-1 bg-white p-2 rounded border">
                                    aws ec2 delete-route \
                                    --route-table-id <strong x-text="rt.route_table_id"></strong> \
                                    --destination-cidr-block <strong x-text="rt.destination"></strong>
                                                </pre>
                                                </template>
                                            </div>

                                            <!-- Step 3 -->
                                            <div class="mb-2">
                                                <span class="font-semibold text-indigo-700">3.</span>
                                                Verify no remaining dependencies
                                                <pre class="mt-1 bg-white p-2 rounded border">
                                    aws ec2 describe-nat-gateways --filter Name=vpc-id,Values=<strong x-text="igw.attached_vpc_id"></strong>
                                    aws ec2 describe-network-interfaces --filters Name=vpc-id,Values=<strong x-text="igw.attached_vpc_id"></strong>
                                            </pre>
                                            </div>

                                            <!-- Step 4 -->
                                            <div>
                                                <span class="font-semibold text-indigo-700">4.</span>
                                                Delete Internet Gateway
                                                <pre class="mt-1 bg-white p-2 rounded border">
                                    aws ec2 delete-internet-gateway \
                                    --internet-gateway-id <strong x-text="igw.internet_gateway_id"></strong>
                                            </pre>
                                            </div>

                                            <div class="mt-2 italic text-slate-500">
                                                Read-only guidance. Commands are not executed automatically.
                                            </div>
                                        </div>


                                    </div>

                                </div>

                            </template>

                            <template x-if="internetGatewayInspection.length === 0">
                                <div class="italic text-slate-400">
                                    No Internet Gateways found.
                                </div>
                            </template>

                        </div>
                    </div>



                    <!-- NAT GATEWAYS -->
                    <div>
                        <button @click="expandedValidation.nat_gateways = !expandedValidation.nat_gateways"
                            class="text-sm font-medium text-slate-700 hover:underline">
                            ‚ñ∏ NAT Gateways (<span x-text="vpcInspectionResult.summary.nat_gateways"></span>)
                        </button>

                        <ul x-show="expandedValidation.nat_gateways" class="mt-2 ml-4 text-sm text-slate-600 space-y-1">
                            <template x-for="nat in vpcInspectionResult.details.nat_gateways" :key="nat.nat_gateway_id">
                                <li>
                                    ‚Ä¢ <strong x-text="nat.nat_gateway_id"></strong>
                                    (subnet:
                                    <span x-text="nat.subnet_id"></span>,
                                    state:
                                    <span x-text="nat.state"></span>)
                                </li>
                            </template>
                        </ul>
                    </div>


                    <!-- NETWORK INTERFACES -->
                    <div>
                        <button @click="expandedValidation.network_interfaces = !expandedValidation.network_interfaces"
                            class="text-sm font-medium text-slate-700 hover:underline">
                            ‚ñ∏ Network Interfaces (<span x-text="vpcInspectionResult.summary.network_interfaces"></span>)
                        </button>

                        <ul x-show="expandedValidation.network_interfaces"
                            class="mt-2 ml-4 text-sm text-slate-600 space-y-1">
                            <template x-for="eni in vpcInspectionResult.details.network_interfaces"
                                :key="eni.network_interface_id">
                                <li>
                                    ‚Ä¢ <strong x-text="eni.network_interface_id"></strong>
                                    (subnet:
                                    <span x-text="eni.subnet_id"></span>,
                                    status:
                                    <span x-text="eni.status"></span>)
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================================= -->
    <!-- TAB 6: OBSERVABILITY - LOGS (LOCAL DEV) -->
    <!-- ============================================================= -->
    <div x-show="activeTab === 'logs'" x-cloak class="space-y-6">

        <!-- ============================= -->
        <!-- BACKEND HEALTH BADGE (OBSERVABILITY SCOPE) -->
        <!-- ============================= -->
        <template x-if="backendHealth">
            <div class="flex items-center space-x-2">
                <template x-if="backendHealth.status === 'ok'">
                    <div class="flex items-center space-x-2 text-green-700">
                        <span>üü¢</span>
                        <span class="text-sm font-medium">Backend healthy</span>
                        <span class="text-xs text-slate-500">
                            (<span x-text="backendHealth.service"></span>)
                        </span>
                    </div>
                </template>

                <template x-if="backendHealth.status !== 'ok'">
                    <div class="flex items-center space-x-2 text-red-700">
                        <span>üî¥</span>
                        <span class="text-sm font-medium">Backend unreachable</span>
                    </div>
                </template>
            </div>
        </template>

        <!-- ============================= -->
        <!-- OBSERVABILITY CONTENT -->
        <!-- ============================= -->
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-5 text-slate-700">
            <h2 class="text-lg font-semibold text-slate-800 mb-2">
                Observability ‚Äì Logs
            </h2>

            <template x-if="
                                            recentLogs.length === 0 &&
                                            window.location.hostname === 'localhost'
                                        ">
                <div class="mt-3">
                    <h3 class="font-semibold text-slate-800 mb-2">
                        CloudWatch logs unavailable (local development)
                    </h3>

                    <p class="text-sm mb-2">
                        Your NetPilot AI backend is running locally and is healthy.
                        CloudWatch logs are only available when the application is deployed to AWS
                        (ECS, EC2, or Lambda).
                    </p>

                    <p class="text-sm text-slate-500">
                        When deployed, backend logs will appear here automatically
                        without any UI changes.
                    </p>
                </div>
            </template>
        </div>

    </div>




    <!-- ============================================================= -->
    <!-- ALPINE.JS LOGIC (Single Source of Truth) -->
    <!-- ============================================================= -->
    <script>
        function networkConsole() {
            return {
                // =============================
                // INIT (ordered, no races)
                // =============================
                async init() {
                    await this.loadVPCs();        // sets selectedVpcId safely
                    await this.loadAZs();         // Loads Availability Zones
                    await this.loadSubnets();     // now selectedVpcId exists
                    await this.loadRouteTables(); // Loads Route Tables
                    await this.loadLogs();        // OBSERVABILITY ‚Äì LOG INIT (STEP 1c)
                    await this.loadBackendHealth(); // Loads Health status

                },

                // =============================
                // GLOBAL STATE
                // =============================
                activeTab: 'network',
                globalError: null,

                // =============================
                // OBSERVABILITY ‚Äì LOG STATE (STEP 1)
                // =============================
                recentLogs: [],
                lastKnownLogs: [],
                logWindowMinutes: 15,
                fallbackWindowMinutes: 30,


                onVpcSelected() {
                    if (!this.selectedVpcId) {
                        this.subnets = [];
                        return;
                    }
                    this.loadSubnets();
                },

                showError(msg) {
                    this.globalError = msg;
                    setTimeout(() => (this.globalError = null), 6000);
                },

                // =============================
                // INFO TOGGLES
                // =============================
                showVpcInfo: true,
                showRoutesInfo: true,
                showIGWInfo: true,
                showNatInfo: true,

                // =============================
                // CORE DATA (single definitions)
                // =============================
                vpcs: [],
                selectedVpcId: '',
                validationVpcId: "",
                subnets: [],
                availabilityZones: [],
                routeTables: [],

                // =============================
                // VPC UI
                // =============================
                showCreateVPC: false,
                newVpcCidr: '10.0.0.0/16',

                async createVPC() {
                    if (!this.newVpcCidr) return this.showError('VPC CIDR is required');
                    try {
                        const res = await fetch(`/api/v1/aws/vpcs?cidr=${encodeURIComponent(this.newVpcCidr)}`, { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'VPC creation failed');
                        this.showCreateVPC = false;
                        await this.loadVPCs();
                        await this.loadSubnets();
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to create VPC');
                    }
                },

                async deleteVPC(vpc) {
                    if (!vpc?.vpc_id) return this.showError('Invalid VPC');
                    if (!confirm(`Delete VPC ${vpc.vpc_id}? This cannot be undone.`)) return;
                    try {
                        const res = await fetch(`/api/v1/aws/vpc/${vpc.vpc_id}/delete`, { method: 'DELETE' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'VPC delete failed');
                        await this.loadVPCs();
                        await this.loadSubnets();
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to delete VPC');
                    }
                },

                async safeDeleteVPC(vpc) {
                    if (!vpc?.vpc_id) return this.showError('Invalid VPC');
                    if (!confirm(`Safe delete VPC ${vpc.vpc_id}?\nDependencies will be checked first.`)) return;
                    try {
                        const res = await fetch(`/api/v1/aws/vpc/${vpc.vpc_id}/safe-delete`, { method: 'DELETE' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'Safe delete blocked');
                        await this.loadVPCs();
                        await this.loadSubnets();
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to safe-delete VPC');
                    }
                },

                // =============================
                // SUBNET UI
                // =============================
                showCreateSubnet: false,
                subnetError: '',

                newSubnetVPC: '',
                newSubnetVPCManual: '',
                newSubnetCIDR: '',
                newSubnetAZ: '',
                newSubnetName: '',

                closeSubnetModal() {
                    this.showCreateSubnet = false;
                    this.newSubnetVPC = '';
                    this.newSubnetVPCManual = '';
                    this.newSubnetCIDR = '';
                    this.newSubnetAZ = '';
                    this.newSubnetName = '';
                    this.subnetError = '';
                },

                async submitCreateSubnet() {
                    this.subnetError = '';
                    const vpcId = this.newSubnetVPC || this.newSubnetVPCManual;

                    if (!vpcId || !this.newSubnetCIDR || !this.newSubnetAZ) {
                        this.subnetError = 'Missing required subnet fields';
                        return;
                    }

                    try {
                        const url =
                            `/api/v1/aws/subnets` +
                            `?vpc_id=${encodeURIComponent(vpcId)}` +
                            `&cidr=${encodeURIComponent(this.newSubnetCIDR)}` +
                            `&availability_zone=${encodeURIComponent(this.newSubnetAZ)}` +
                            `&name=${encodeURIComponent(this.newSubnetName || 'Subnet')}`;

                        const res = await fetch(url, { method: 'POST' });
                        const data = await res.json();

                        if (!res.ok || data.status === 'failed') {
                            this.subnetError = data.error || 'Subnet creation failed';
                            return;
                        }

                        this.showCreateSubnet = false;
                        await this.loadSubnets();
                        await this.loadRouteTables();
                    } catch {
                        this.subnetError = 'Failed to create subnet';
                    }
                },

                async deleteSubnet(subnet) {
                    if (!subnet?.subnet_id) return this.showError('Invalid subnet');
                    if (!confirm(`Delete subnet ${subnet.subnet_id}?`)) return;

                    try {
                        const res = await fetch(`/api/v1/aws/subnets/${subnet.subnet_id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'Subnet delete failed');
                        await this.loadSubnets();
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to delete subnet');
                    }
                },

                // =============================
                // ROUTE TABLE UI (keep as-is, cleaned)
                // =============================
                showCreateRTB: false,
                showAssociateRTB: false,
                showAddRoute: false,

                newRTBVPC: '',
                newRTBName: 'NetPilot-RTB',
                newRTBDescription: '',

                selectedRTBId: '',
                selectedSubnetForAssoc: '',
                candidateSubnetsForRTB: [],

                rtbCreateError: '',
                rtbAssocError: '',

                addRouteRTBId: '',
                addRouteDestination: '',
                addRouteTargetType: 'igw',
                addRouteTargetId: '',
                addRouteError: '',

                openCreateRTBModal() {
                    this.showCreateRTB = true;
                    this.rtbCreateError = '';
                    this.newRTBVPC = '';
                    this.newRTBName = 'NetPilot-RTB';
                    this.newRTBDescription = '';
                },

                closeCreateRTBModal() {
                    this.showCreateRTB = false;
                    this.newRTBVPC = '';
                    this.newRTBName = 'NetPilot-RTB';
                    this.newRTBDescription = '';
                    this.rtbCreateError = '';
                },

                openAssocModal(rt) {
                    this.selectedRTBId = rt.route_table_id;
                    this.selectedSubnetForAssoc = '';
                    this.candidateSubnetsForRTB = this.subnets.filter(s => s.vpc_id === rt.vpc_id);
                    this.rtbAssocError = '';
                    this.showAssociateRTB = true;
                },

                closeAssocModal() {
                    this.showAssociateRTB = false;
                    this.selectedRTBId = '';
                    this.selectedSubnetForAssoc = '';
                    this.candidateSubnetsForRTB = [];
                    this.rtbAssocError = '';
                },

                async associateRouteTable() {
                    this.rtbAssocError = '';
                    if (!this.selectedRTBId || !this.selectedSubnetForAssoc) {
                        this.rtbAssocError = 'Please select a subnet';
                        return;
                    }

                    try {
                        const res = await fetch(
                            `/api/v1/aws/route-tables/${this.selectedRTBId}/associate?subnet_id=${encodeURIComponent(this.selectedSubnetForAssoc)}`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') {
                            this.rtbAssocError = data.error || 'Association failed';
                            return;
                        }

                        this.closeAssocModal();
                        await this.loadRouteTables();
                    } catch {
                        this.rtbAssocError = 'Failed to associate route table';
                    }
                },

                async deassociateRouteTable(associationId) {
                    if (!associationId) return;
                    try {
                        const res = await fetch(`/api/v1/aws/route-tables/${associationId}/disassociate`, { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'Failed to de-associate route table');
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to de-associate route table');
                    }
                },

                async submitCreateRTB() {
                    this.rtbCreateError = '';
                    if (!this.newRTBVPC) {
                        this.rtbCreateError = 'Please select a VPC';
                        return;
                    }

                    try {
                        const res = await fetch('/api/v1/aws/route-tables', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                vpc_id: this.newRTBVPC,
                                name: this.newRTBName,
                                description: this.newRTBDescription || ''
                            })
                        });

                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') {
                            this.rtbCreateError = data.error || 'Route table creation failed';
                            return;
                        }

                        this.closeCreateRTBModal();
                        await this.loadRouteTables();
                    } catch {
                        this.rtbCreateError = 'Failed to create route table';
                    }
                },

                openAddRouteModal(rt) {
                    this.addRouteRTBId = rt.route_table_id;
                    this.addRouteDestination = '';
                    this.addRouteTargetType = 'igw';
                    this.addRouteTargetId = '';
                    this.addRouteError = '';
                    this.showAddRoute = true;
                },

                closeAddRouteModal() {
                    this.showAddRoute = false;
                    this.addRouteRTBId = '';
                    this.addRouteDestination = '';
                    this.addRouteTargetType = 'igw';
                    this.addRouteTargetId = '';
                    this.addRouteError = '';
                },

                async submitAddRoute() {
                    this.addRouteError = '';
                    if (!this.addRouteRTBId || !this.addRouteDestination || !this.addRouteTargetType || !this.addRouteTargetId) {
                        this.addRouteError = 'All fields are required';
                        return;
                    }

                    try {
                        const res = await fetch(`/api/v1/aws/route-tables/${this.addRouteRTBId}/routes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                destination_cidr: this.addRouteDestination,
                                target_type: this.addRouteTargetType,
                                target_id: this.addRouteTargetId,
                            }),
                        });

                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') {
                            this.addRouteError = data.error || 'Failed to add route';
                            return;
                        }

                        this.closeAddRouteModal();
                        await this.loadRouteTables();
                    } catch {
                        this.addRouteError = 'Failed to add route';
                    }
                },

                async deleteRouteTable(rt) {
                    if (rt?.is_main) return;
                    try {
                        const res = await fetch(`/api/v1/aws/route-tables/${rt.route_table_id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'Route table delete failed');
                        await this.loadRouteTables();
                    } catch {
                        this.showError('Failed to delete route table');
                    }
                },

                // =============================
                // IGW
                // =============================
                internetGateways: [],
                igwError: null,

                showCreateIGW: false,
                showAttachIGW: false,
                showDetachIGWConfirm: false,

                igwCreateError: '',
                igwAttachError: null,
                igwDetachError: null,

                newIGWName: '',
                selectedIGWId: null,

                selectedVpcForIGWAttach: '',
                selectedVpcForIGWAttachManual: '',
                selectedVpcForIGWDetach: '',
                selectedVpcForIGWDetachManual: '',

                closeCreateIGWModal() {
                    this.showCreateIGW = false;
                    this.newIGWName = '';
                    this.igwCreateError = '';
                },

                async submitCreateIGW() {
                    this.igwCreateError = '';
                    try {
                        const res = await fetch(`/api/v1/aws/internet-gateways?name=${encodeURIComponent(this.newIGWName || '')}`, { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') {
                            this.igwCreateError = data.error || 'Failed to create Internet Gateway';
                            return;
                        }
                        this.closeCreateIGWModal();
                        await this.loadInternetGateways();
                    } catch {
                        this.igwCreateError = 'Failed to create Internet Gateway';
                    }
                },

                openAttachIGWModal(igwId) {
                    this.selectedIGWId = igwId;
                    this.selectedVpcForIGWAttach = '';
                    this.selectedVpcForIGWAttachManual = '';
                    this.igwAttachError = '';
                    this.showAttachIGW = true;
                },

                closeAttachIGWModal() {
                    this.showAttachIGW = false;
                    this.selectedIGWId = null;
                },

                async submitAttachIGW() {
                    const vpcId = this.selectedVpcForIGWAttach || this.selectedVpcForIGWAttachManual;
                    if (!this.selectedIGWId || !vpcId) {
                        this.igwAttachError = 'IGW and VPC are required';
                        return;
                    }

                    try {
                        const res = await fetch(`/api/v1/aws/internet-gateways/${this.selectedIGWId}/attach?vpc_id=${encodeURIComponent(vpcId)}`, { method: 'POST' });
                        const d = await res.json();
                        if (!res.ok || d.status === 'failed') {
                            this.igwAttachError = d.error || 'Attach failed';
                            return;
                        }

                        this.showAttachIGW = false;
                        await this.loadInternetGateways();
                    } catch {
                        this.igwAttachError = 'Failed to attach Internet Gateway';
                    }
                },

                promptDetachIGW(igw) {
                    this.selectedIGWId = igw.internet_gateway_id;
                    this.selectedVpcForIGWDetach = '';
                    this.selectedVpcForIGWDetachManual = '';
                    this.igwDetachError = '';
                    this.showDetachIGWConfirm = true;
                },

                closeDetachIGWModal() {
                    this.showDetachIGWConfirm = false;
                    this.selectedIGWId = null;
                },

                async submitDetachIGW() {
                    const vpcId = this.selectedVpcForIGWDetach || this.selectedVpcForIGWDetachManual;
                    if (!this.selectedIGWId || !vpcId) {
                        this.igwDetachError = 'VPC is required to detach';
                        return;
                    }

                    try {
                        const res = await fetch(`/api/v1/aws/internet-gateways/${this.selectedIGWId}/detach?vpc_id=${encodeURIComponent(vpcId)}`, { method: 'POST' });
                        const d = await res.json();
                        if (!res.ok || d.status === 'failed') {
                            this.igwDetachError = d.error || 'Detach failed';
                            return;
                        }

                        this.showDetachIGWConfirm = false;
                        await this.loadInternetGateways();
                    } catch {
                        this.igwDetachError = 'Failed to detach Internet Gateway';
                    }
                },

                async deleteIGW(igwId) {
                    if (!confirm(`Delete Internet Gateway ${igwId}? It must be detached first.`)) return;
                    try {
                        const res = await fetch(`/api/v1/aws/internet-gateways/${igwId}`, { method: 'DELETE' });
                        const d = await res.json();
                        if (!res.ok || d.status === 'failed') return this.showError(d.error || 'Delete failed');
                        await this.loadInternetGateways();
                    } catch {
                        this.showError('Failed to delete Internet Gateway');
                    }
                },

                // =============================
                // NAT
                // =============================
                natGateways: [],
                natError: null,

                showCreateNAT: false,
                newNATSubnetId: '',
                newNATName: 'NetPilot-NAT',
                natCreateError: '',

                openCreateNATModal() {
                    this.natCreateError = '';
                    this.newNATSubnetId = '';
                    this.showCreateNAT = true;
                },

                closeCreateNATModal() {
                    this.showCreateNAT = false;
                    this.natCreateError = '';
                },

                async submitCreateNAT() {
                    this.natCreateError = '';
                    if (!this.newNATSubnetId) {
                        this.natCreateError = 'Please select a subnet';
                        return;
                    }

                    try {
                        const res = await fetch(
                            `/api/v1/aws/nat-gateways?subnet_id=${encodeURIComponent(this.newNATSubnetId)}` +
                            (this.newNATName ? `&name=${encodeURIComponent(this.newNATName)}` : ''),
                            { method: 'POST' }
                        );

                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') {
                            this.natCreateError = data.error || 'Failed to create NAT Gateway';
                            return;
                        }

                        this.closeCreateNATModal();
                        await this.loadNatGateways();
                    } catch {
                        this.natCreateError = 'Failed to create NAT Gateway';
                    }
                },

                async deleteNatGateway(ngw) {
                    if (!ngw?.nat_gateway_id) return this.showError('Invalid NAT Gateway');
                    if (!confirm(`Delete NAT Gateway ${ngw.nat_gateway_id}?`)) return;

                    try {
                        const res = await fetch(`/api/v1/aws/nat-gateways/${ngw.nat_gateway_id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (!res.ok || data.status === 'failed') return this.showError(data.error || 'Delete failed');
                        await this.loadNatGateways();
                    } catch {
                        this.showError('Failed to delete NAT Gateway');
                    }
                },

                // =============================
                // VALIDATION (kept compatible)
                // =============================
                vpcInspectionResult: null,
                vpcInspectionError: null,
                inspectingVpc: false,

                internetGatewayInspection: [],

                expandedValidation: {
                    subnets: false,
                    route_tables: false,
                    internet_gateways: false,
                    nat_gateways: false,
                    network_interfaces: false,
                    route_tables_inspection: false,
                    subnets_inspection: false
                },

                routeTableInspection: null,
                routeTableLoading: false,
                routeTableError: null,

                subnetInspection: null,
                subnetLoading: false,
                subnetErrorValidation: null,

                async loadRouteTableValidation() {
                    if (!this.selectedVpcId) return;
                    this.routeTableLoading = true;
                    this.routeTableError = null;

                    try {
                        const res = await fetch(`/api/v1/aws/route-tables/inspect?vpc_id=${this.selectedVpcId}`);
                        const data = await res.json();

                        if (!res.ok) {
                            this.routeTableError = data.error || 'Failed to load route tables';
                            this.routeTableInspection = null;
                            return;
                        }

                        this.routeTableInspection = data;
                    } catch {
                        this.routeTableError = 'Failed to contact backend';
                        this.routeTableInspection = null;
                    } finally {
                        this.routeTableLoading = false;
                    }
                },

                async loadSubnetInspection() {
                    this.subnetLoading = true;
                    this.subnetErrorValidation = null;

                    try {
                        const vpcId = this.vpcInspectionResult?.vpc_id;
                        if (!vpcId) return;

                        const res = await fetch(`/api/v1/aws/vpcs/${vpcId}/subnets/inspection`);
                        const data = await res.json();

                        if (!res.ok) {
                            this.subnetErrorValidation = data.error || 'Failed to load subnet inspection';
                            return;
                        }

                        this.subnetInspection = data;
                    } catch {
                        this.subnetErrorValidation = 'Failed to load subnet inspection';
                    } finally {
                        this.subnetLoading = false;
                    }
                },


                async inspectVpcDependencies() {
                    if (!this.selectedVpcId) return;

                    this.inspectingVpc = true;
                    this.vpcInspectionError = null;

                    this.vpcInspectionResult = null;
                    this.internetGatewayInspection = [];
                    this.routeTableInspection = null;
                    this.subnetInspection = null;

                    const vpcId = this.selectedVpcId;



                    try {
                        const res = await fetch(`/api/v1/aws/vpcs/${vpcId}/inspect`);
                        const data = await res.json();

                        if (!res.ok) {
                            this.vpcInspectionError = data.error || 'Inspection failed';
                            return;
                        }

                        this.vpcInspectionResult = data;

                        await this.loadRouteTableValidation();
                        await this.loadSubnetInspection();

                        try {
                            const igwRes = await fetch(`/api/v1/aws/internet-gateways/inspect?vpc_id=${vpcId}`);
                            const igwData = await igwRes.json();
                            this.internetGatewayInspection = Array.isArray(igwData.details) ? igwData.details : [];
                        } catch {
                            this.internetGatewayInspection = [];
                        }

                    } catch {
                        this.vpcInspectionError = 'Failed to contact backend';
                    } finally {
                        this.inspectingVpc = false;
                        // Refresh inventory so UI stays consistent
                        await this.loadSubnets();
                    }

                },


                // =============================
                // HEALTH (unchanged)
                // =============================
                backendHealth: null,
                awsHealth: null,
                awsLegacyHealth: null,
                healthError: null,
                healthCheckedAt: null,

                async checkBackendHealth() {
                    try {
                        const r = await fetch('/api/v1/health');
                        this.backendHealth = await r.json();
                    } catch {
                        this.backendHealth = { status: 'failed' };
                    }
                },

                async checkAwsHealth() {
                    try {
                        const r = await fetch('/api/v1/aws/health');
                        this.awsHealth = await r.json();
                    } catch {
                        this.awsHealth = { status: 'failed' };
                    }
                },

                async checkAwsLegacyHealth() {
                    try {
                        const r = await fetch('/api/v1/aws/health/legacy');
                        this.awsLegacyHealth = await r.json();
                    } catch {
                        this.awsLegacyHealth = { status: 'failed' };
                    }
                },

                async checkAllHealth() {
                    this.healthError = null;
                    this.healthCheckedAt = new Date().toISOString();
                    await Promise.all([this.checkBackendHealth(), this.checkAwsHealth(), this.checkAwsLegacyHealth()]);
                },

                // =============================
                // LOADERS (stable + subnet fix)
                // =============================
                async loadVPCs() {
                    try {
                        const r = await fetch('/api/v1/aws/vpcs');
                        const d = await r.json();
                        this.vpcs = d.vpcs || [];

                        if (this.vpcs.length && !this.selectedVpcId) {
                            this.selectedVpcId = this.vpcs[0].vpc_id;
                        }
                    } catch {
                        this.showError('Failed to load VPCs');
                    }
                },

                async loadSubnets() {
                    if (!this.selectedVpcId) {
                        this.subnets = [];
                        return;
                    }

                    try {
                        const r = await fetch(`/api/v1/aws/subnets?vpc_id=${encodeURIComponent(this.selectedVpcId)}`);
                        const d = await r.json();

                        // ‚úÖ FIX: accept both response shapes
                        if (Array.isArray(d)) this.subnets = d;
                        else if (Array.isArray(d.subnets)) this.subnets = d.subnets;
                        else this.subnets = [];

                    } catch {
                        this.showError('Failed to load subnets');
                        this.subnets = [];
                    }
                },

                async loadAZs() {
                    try {
                        const r = await fetch('/api/v1/aws/availability-zones');
                        const d = await r.json();
                        this.availabilityZones = d.availability_zones || d.zones || [];
                    } catch {
                        this.showError('Failed to load Availability Zones');
                        this.availabilityZones = [];
                    }
                },

                async loadRouteTables() {
                    try {
                        const r = await fetch('/api/v1/aws/route-tables');
                        const d = await r.json();
                        this.routeTables = d.route_tables || [];
                    } catch {
                        this.showError('Failed to load route tables');
                    }
                },

                async loadInternetGateways() {
                    try {
                        const r = await fetch('/api/v1/aws/internet-gateways');
                        const d = await r.json();
                        this.internetGateways = (d.internet_gateways || []).map(igw => ({
                            ...igw,
                            attached_vpc_ids: igw.attached_vpc_id ? [igw.attached_vpc_id] : []
                        }));
                    } catch {
                        this.showError('Failed to load Internet Gateways');
                    }
                },

                // =============================
                // OBSERVABILITY ‚Äì LOG LOADING (STEP 1b)
                // =============================
                async loadLogs() {
                    try {
                        // 1Ô∏è‚É£ Fetch recent logs (15 minutes)
                        const recentRes = await fetch(
                            `/api/v1/logs/recent?window=${this.logWindowMinutes}`
                        );
                        const recentData = await recentRes.json();
                        this.recentLogs = recentData.logs || [];

                        // 2Ô∏è‚É£ If no recent logs, fetch fallback logs (30 minutes)
                        if (this.recentLogs.length === 0) {
                            const fallbackRes = await fetch(
                                `/api/v1/logs/recent?window=${this.fallbackWindowMinutes}`
                            );
                            const fallbackData = await fallbackRes.json();
                            this.lastKnownLogs = fallbackData.logs || [];
                        }
                    } catch (err) {
                        console.error('Failed to load logs', err);
                        this.showError('Unable to load backend logs');
                    }
                },


                async loadNatGateways() {
                    try {
                        const r = await fetch('/api/v1/aws/nat-gateways');
                        const d = await r.json();
                        this.natGateways = (d.nat_gateways || []).map(ngw => ({
                            ...ngw,
                            public_ip: ngw.addresses && ngw.addresses.length ? ngw.addresses[0].public_ip : null
                        }));
                    } catch {
                        this.showError('Failed to load NAT Gateways');
                    }
                },

                async loadBackendHealth() {
                    try {
                        const res = await fetch('/api/v1/health');
                        this.backendHealth = await res.json();
                    } catch (e) {
                        this.backendHealth = { status: 'error' };
                    }
                },

            };
        }
    </script>


    {% endblock %}
